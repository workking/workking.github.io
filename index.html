<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <!-- Custom CSS -->
    <style>
      html, body, .container-fluid {
        height: 100%;
        overflow: hidden;
      }
      #raw-container td {
        /* text-overflow: ellipsis; */
		    white-space: nowrap;
      }
    </style>
    <title>Virus Search</title>
  </head>
  <body>

    <!-- Container -->
    <div class="container-fluid">
      <div class="row h-100">

        <!-- Column paste content -->
        <div class="col-sm-8 h-100 px-0 d-flex flex-column border-right">
          <nav class="navbar navbar-light border-bottom bg-light">
            <a class="navbar-brand p-1" href="#">Virus Search</a>
            <small class="text-muted ml-auto">最後更新 - 2020-07-28</small>
          </nav>
          <form class="mt-3 px-3 border-bottom">
            <div class="form-group">
              <textarea id="input-area" class="form-control" placeholder="輸入地址"></textarea>
            </div>
          </form>
          <div id="result-container" class="flex-fill table-responsive"></div>
          <!-- <nav class="navbar navbar-light border-top bg-light form-inline">
            <button class="btn btn-primary ml-auto">Export</button>
          </nav> -->
        </div>
        <!-- End of - Column paste content -->

        <!-- Column Raw Data -->
        <div class="col-sm h-100 px-0 d-flex flex-column">
          <nav class="navbar navbar-light border-bottom bg-light p-2">
            <form id="searchFormRaw" class="input-group">
              <select class="custom-select">
                <option value="chi">中</option>
                <option value="eng">英</option>
              </select>
              <input class="form-control" placeholder="輸入地址"/>
              <div class="input-group-append">
                <button class="btn btn-success">搜索</button>
              </div>
            </form>
          </nav>
          <div id="raw-container" class="flex-fill table-responsive"></div>
        </div>
        <!-- End of - Column Raw Dßata -->
        
      </div>

    </div>

    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>
    
    <!-- Custom Scripts-->
    <script src="./gov_data_chi.js"></script>
    <script src="./gov_data_eng.js"></script>
    <script type="text/javascript">

      $(document).ready(function() {

        const fields = {
          district: {
            eng: 'District',
            chi: '地區'
          },
          building: {
            eng: 'Building name',
            chi: '大廈名單'
          },
          date: {
            eng: 'Last date of residence of the case(s)',
            chi: '最後個案居住日期'
          },
          cases: {
            eng: 'Related probable/confirmed cases',
            chi: '相關疑似/確診個案'
          }
        };

        var GOV_DATA = {
          chi: gov_data_chi.map(item => convertResultItem(item, 'chi')),
          eng: gov_data_eng.map(item => convertResultItem(item, 'eng')),
        };

        var addressByLocale = {};
        var addressConcatByLocale = {};

        // retrives json data
        for (let locale of ['eng', 'chi']) {
          addressByLocale[locale] = GOV_DATA[locale].map(item => item.building);
          addressConcatByLocale[locale] =  ' ' + addressByLocale[locale].join('|').toLowerCase() + ' ';
        }

        // get element
        var $inputArea = $('#input-area');
        var $resultContainer = $('#result-container');
        var $rawContainer = $('#raw-container');
        var $searchFormRaw = $('#searchFormRaw');

        $inputArea.bind('paste', function(e) {
          setTimeout(function () {
            $inputArea.trigger('change');
          }, 10);
        });

        // on paste content input
        $inputArea.change(function(e) {
          var $this = $(this);
          var content = $this.val();

          var contentGrid = $.map(content.split('\n'), function(val) {
            return [val.trim().split(/\t/)];
          });

          // get max col count
          var colCount = 0;
          $.each(contentGrid, function(i, val) {
            colCount = Math.max(val.length, colCount);
          });

          // new grid with same row count
          var tableContentGrid = $.map(contentGrid, function(val) {
            var lengthDiff = colCount - val.length;
            return [(lengthDiff === 0) ? val : val.concat(Array(lengthDiff).fill(''))];
          });

          // build table
          $resultContainer
          .empty()
          .append(buildGridTable(tableContentGrid));

          // calculate score for each row
          $resultContainer.find('td').each(function() {
            var $this = $(this);
            var cellContent = $this.html();

            // first break strinng to by space
            var stringConponent = cellContent.replace(/([^\u0000-\u00ff]{1})/g, '$1 ').split(' ');
            
            // get score
            var engMatches = getSearchResult(stringConponent, ' ', addressConcatByLocale.eng);
            var chiMatches = getSearchResult(stringConponent, '', addressConcatByLocale.chi);

            for (var match of engMatches) {
              cellContent = cellContent.replace(match.text, createHighlightAnchor(match.text, getMatchAnchorClass(match.combo.length), 'eng'));
            }
            for (var match of chiMatches) {
              cellContent = cellContent.replace(match.text, createHighlightAnchor(match.text, getMatchAnchorClass(match.combo.length), 'chi'));
            }

            $this.html(cellContent);
          });

        });


        $resultContainer.on('click', '.archor-match', function(event) {
          event.preventDefault();
          var $this = $(this);
          $searchFormRaw.find('select').val($this.data('locale'));
          $searchFormRaw.find('input').val($(this).html());
          $searchFormRaw.submit();
        });

        $searchFormRaw.submit(function(event) {
          event.preventDefault();
          reloadRawTable();
        });

        reloadRawTable();

        function reloadRawTable() {

          // get form params
          var locale = $searchFormRaw.find('select').val();
          var keyword = $searchFormRaw.find('input').val();

          // build raw table
          var rawTableGrid = $.map(GOV_DATA[locale], function(item) {
            var building = item.building;

            var row = [
              item.district,
              item.building,
              item.date,
              item.cases
            ];

            if (keyword && (!building || building.toLowerCase().search(escapeRegExp(keyword)) === -1)) {
              return null;
            }
            return [row];
          });

          $rawContainer.empty().append(buildGridTable(rawTableGrid));
        }



        /**
         * Table building functions
         **/
        function buildGridTable(tableContentGrid) {
          return $('<table/>')
          .addClass('table table-striped table-sm table-bordered')
          .append($('<tbody/>')
            .append($.map(tableContentGrid, buildGridTableRow))
          );
        }

        function buildGridTableRow(contentRow) {
          return $('<tr/>')
          .data('content', contentRow)
          .append($.map(contentRow, buildGridTableCell));
        }

        function buildGridTableCell(contentItem) {
          return $('<td/>').text(contentItem);
        }

        function createHighlightAnchor(text, className, locale) {
          return $('<a>').attr('href', '#')
          .attr('data-locale', locale)
          .addClass('archor-match')
          .addClass(className)
          .text(text)
          .prop('outerHTML');
        }

        function getMatchAnchorClass(length) {
          return length > 3 ? 'text-light bg-danger' : 'text-dark bg-warning';
        }

        function convertResultItem(item, locale) {
          return {
            district: item[fields.district[locale]],
            building: item[fields.building[locale]],
            date:     item[fields.date[locale]],
            cases:    item[fields.cases[locale]]
          }
        }

        /**
         * Searching function
         **/
        function getSearchResult(keywordComponents, comboJoin, searchFromString) {
          var results = [];
          var combo = [];
          for (var i in keywordComponents) {
            combo.push(keywordComponents[i]);
            var comboString = escapeRegExp(combo.join(comboJoin));
            var search = searchFromString.search(comboString);
            if (search === -1) {
              if (combo.length > 3) {
                combo.pop();
                results.push({ combo, text: combo.join(comboJoin) });
              }
              combo = [];
            }
          }
          return results;
        }

        function escapeRegExp(text) {
          return text.replace(/[-[\]{}()*+?.,\\^$|#\s]/g, '\\$&').toLowerCase();
        }
      });
    </script>

  </body>
</html>